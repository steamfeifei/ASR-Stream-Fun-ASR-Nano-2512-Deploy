<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FunASR å®æ—¶è¯­éŸ³è¯†åˆ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .result-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 200px;
        }
        
        .result-panel h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        #resultText {
            font-size: 18px;
            line-height: 1.8;
            color: #2c3e50;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .log-panel {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .log-panel h3 {
            margin-bottom: 15px;
            color: #ecf0f1;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid #3498db;
            padding-left: 10px;
        }
        
        .log-entry.info {
            border-left-color: #3498db;
        }
        
        .log-entry.success {
            border-left-color: #2ecc71;
        }
        
        .log-entry.error {
            border-left-color: #e74c3c;
        }
        
        .log-entry.warning {
            border-left-color: #f39c12;
        }
        
        .config-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .config-panel label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        
        .config-panel input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .config-panel input:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ FunASR å®æ—¶è¯­éŸ³è¯†åˆ«</h1>
            <p>æµå¼éŸ³é¢‘è¾“å…¥ï¼Œå®æ—¶è¯†åˆ«ç»“æœå±•ç¤º</p>
        </div>
        
        <div class="content">
            <!-- é…ç½®é¢æ¿ -->
            <div class="config-panel">
                <label>WebSocket æœåŠ¡åœ°å€:</label>
                <input type="text" id="wsUrl" value="ws://xxx.xxx.xxx.xxx:9002" placeholder="ws://localhost:9002">
            </div>
            
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <button class="btn btn-primary" id="connectBtn">è¿æ¥æœåŠ¡</button>
                <button class="btn btn-primary" id="startBtn" disabled>å¼€å§‹å½•éŸ³</button>
                <button class="btn btn-danger" id="stopBtn" disabled>åœæ­¢å½•éŸ³</button>
                <button class="btn btn-danger" id="disconnectBtn" disabled>æ–­å¼€è¿æ¥</button>
            </div>
            
            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div class="status disconnected" id="status">
                âšª æœªè¿æ¥
            </div>
            
            <!-- è¯†åˆ«ç»“æœ -->
            <div class="result-panel">
                <h3>è¯†åˆ«ç»“æœ</h3>
                <div id="resultText">ç­‰å¾…å¼€å§‹å½•éŸ³...</div>
            </div>
            
            <!-- æ—¥å¿—é¢æ¿ -->
            <div class="log-panel">
                <h3>æ—¥å¿—</h3>
                <div id="logContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let audioContext = null;
        let processor = null;
        let input = null;
        let isRecording = false;
        let isConnected = false;
        
        const wsUrlInput = document.getElementById('wsUrl');
        const connectBtn = document.getElementById('connectBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusDiv = document.getElementById('status');
        const resultText = document.getElementById('resultText');
        const logContainer = document.getElementById('logContainer');
        
        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, className) {
            statusDiv.textContent = text;
            statusDiv.className = `status ${className}`;
        }
        
        // é‡é‡‡æ ·å‡½æ•°ï¼šæµè§ˆå™¨é€šå¸¸æ˜¯ 44.1k/48kï¼Œéœ€è¦è½¬ä¸º 16k
        function downsampleBuffer(buffer, sampleRate, outSampleRate) {
            if (outSampleRate === sampleRate) {
                return buffer;
            }
            if (outSampleRate > sampleRate) {
                throw new Error("é™é‡‡æ ·ç‡å¿…é¡»å°äºåŸå§‹é‡‡æ ·ç‡");
            }
            
            const sampleRateRatio = sampleRate / outSampleRate;
            const newLength = Math.round(buffer.length / sampleRateRatio);
            const result = new Int16Array(newLength);
            let offsetResult = 0;
            let offsetBuffer = 0;
            
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                let accum = 0;
                let count = 0;
                
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }
                
                result[offsetResult] = Math.min(1, Math.max(-1, accum / count)) * 0x7FFF;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            
            return result.buffer;
        }
        
        // è¿æ¥ WebSocket
        function connect() {
            const url = wsUrlInput.value.trim();
            if (!url) {
                addLog('è¯·è¾“å…¥ WebSocket åœ°å€', 'error');
                return;
            }
            
            addLog(`æ­£åœ¨è¿æ¥ ${url}...`, 'info');
            updateStatus('ğŸŸ¡ æ­£åœ¨è¿æ¥...', 'connecting');
            
            try {
                socket = new WebSocket(url);
                socket.binaryType = 'arraybuffer';
                
                socket.onopen = function() {
                    addLog('WebSocket è¿æ¥æˆåŠŸ', 'success');
                    updateStatus('ğŸŸ¢ å·²è¿æ¥', 'connected');
                    isConnected = true;
                    connectBtn.disabled = true;
                    startBtn.disabled = false;
                    disconnectBtn.disabled = false;
                    resultText.textContent = 'è¿æ¥æˆåŠŸï¼Œå¯ä»¥å¼€å§‹å½•éŸ³äº†';
                };
                
                socket.onmessage = function(event) {
                    if (event.data instanceof ArrayBuffer) {
                        addLog(`æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®: ${event.data.byteLength} å­—èŠ‚`, 'info');
                        return;
                    }
                    
                    try {
                        const data = JSON.parse(event.data);
                        addLog(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`, 'info');
                        
                        if (data.text !== undefined) {
                            if (data.is_final) {
                                resultText.textContent += `\n[æœ€ç»ˆ] ${data.text}`;
                                addLog(`æœ€ç»ˆè¯†åˆ«ç»“æœ: ${data.text}`, 'success');
                            } else {
                                // æµå¼æ›´æ–°ï¼šæ›¿æ¢å½“å‰è¡Œ
                                const lines = resultText.textContent.split('\n');
                                const lastLine = lines[lines.length - 1];
                                if (lastLine.startsWith('[å®æ—¶]')) {
                                    lines[lines.length - 1] = `[å®æ—¶] ${data.text}`;
                                } else {
                                    lines.push(`[å®æ—¶] ${data.text}`);
                                }
                                resultText.textContent = lines.join('\n');
                            }
                            // æ»šåŠ¨åˆ°åº•éƒ¨
                            resultText.scrollTop = resultText.scrollHeight;
                        }
                    } catch (e) {
                        addLog(`è§£ææ¶ˆæ¯å¤±è´¥: ${e}`, 'error');
                    }
                };
                
                socket.onerror = function(error) {
                    addLog(`WebSocket é”™è¯¯: ${error}`, 'error');
                    updateStatus('ğŸ”´ è¿æ¥é”™è¯¯', 'disconnected');
                };
                
                socket.onclose = function() {
                    addLog('WebSocket è¿æ¥å·²å…³é—­', 'warning');
                    updateStatus('âšª æœªè¿æ¥', 'disconnected');
                    isConnected = false;
                    connectBtn.disabled = false;
                    startBtn.disabled = true;
                    stopBtn.disabled = true;
                    disconnectBtn.disabled = true;
                    
                    if (isRecording) {
                        stopRecording();
                    }
                };
                
            } catch (e) {
                addLog(`è¿æ¥å¤±è´¥: ${e}`, 'error');
                updateStatus('ğŸ”´ è¿æ¥å¤±è´¥', 'disconnected');
            }
        }
        
        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
            if (isRecording) {
                stopRecording();
            }
        }
        
        // å¼€å§‹å½•éŸ³
        function startRecording() {
            if (!isConnected || !socket) {
                addLog('è¯·å…ˆè¿æ¥æœåŠ¡', 'error');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(function(stream) {
                    addLog('è·å–éº¦å…‹é£æƒé™æˆåŠŸ', 'success');
                    
                    audioContext = new AudioContext();
                    input = audioContext.createMediaStreamSource(stream);
                    
                    // åˆ›å»º ScriptProcessorNode (å…¼å®¹æ€§å¥½)
                    processor = audioContext.createScriptProcessor(4096, 1, 1);
                    
                    input.connect(processor);
                    processor.connect(audioContext.destination);
                    
                    processor.onaudioprocess = function(e) {
                        if (!isRecording || !socket || socket.readyState !== WebSocket.OPEN) {
                            return;
                        }
                        
                        const left = e.inputBuffer.getChannelData(0);
                        
                        // è½¬æ¢ä¸º Int16Array
                        const int16Buffer = new Int16Array(left.length);
                        for (let i = 0; i < left.length; i++) {
                            int16Buffer[i] = Math.max(-32768, Math.min(32767, left[i] * 32768));
                        }
                        
                        // ä¸‹é‡‡æ ·åˆ° 16kHz
                        const pcm16 = downsampleBuffer(int16Buffer, audioContext.sampleRate, 16000);
                        
                        // å‘é€éŸ³é¢‘æ•°æ®
                        socket.send(pcm16);
                    };
                    
                    isRecording = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    resultText.textContent = '[å®æ—¶] æ­£åœ¨å½•éŸ³...\n';
                    addLog('å¼€å§‹å½•éŸ³', 'success');
                    
                    // å‘é€å¼€å§‹ä¿¡å·ï¼ˆå¯é€‰ï¼‰
                    socket.send(JSON.stringify({
                        is_speaking: true,
                        wav_name: "microphone"
                    }));
                    
                })
                .catch(function(err) {
                    addLog(`æ— æ³•è·å–éº¦å…‹é£æƒé™: ${err.message}`, 'error');
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
                });
        }
        
        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            // å‘é€åœæ­¢ä¿¡å·
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    is_speaking: false
                }));
            }
            
            // æ¸…ç†éŸ³é¢‘èµ„æº
            if (input) {
                input.disconnect();
                input = null;
            }
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            addLog('åœæ­¢å½•éŸ³', 'warning');
            resultText.textContent += '\n[å·²åœæ­¢å½•éŸ³]';
        }
        
        // ç»‘å®šäº‹ä»¶
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        startBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);
        
        // åˆå§‹åŒ–æ—¥å¿—
        addLog('é¡µé¢åŠ è½½å®Œæˆ', 'info');
        addLog('è¯·å…ˆè¿æ¥ WebSocket æœåŠ¡', 'info');
    </script>
</body>
</html>

